input {
  file {
    path => "/data/input/*.csv"
    start_position => "beginning"
    sincedb_path => "/dev/null" # Ideally persist this in prod
  }
}

filter {
  csv {
    columns => ["token", "symbol", "name", "expiry", "strike", "segment"]
    separator => ","
    skip_header => "true"
  }

  mutate {
    convert => { 
      "strike" => "float"
      "token" => "integer"
    }
    uppercase => [ "symbol" ]
    strip => ["symbol", "name", "segment"]
  }

  # Parse expiry date if present (assuming DD-MM-YYYY or similar format, adjust pattern as needed)
  if [expiry] {
    date {
      match => ["expiry", "dd-MMM-yyyy", "dd-MM-yyyy", "yyyy-MM-dd"]
      target => "expiry"
    }
  }

  # Brand mapping logic: "Jio" -> "RELIANCE"
  translate {
    field => "symbol"
    destination => "brand_name"
    dictionary => { 
      "RELIANCE" => "Jio" 
      "NESTLEIND" => "Maggi" 
      "TITAN" => "Tanishq"
      "HINDUNILVR" => "Surf Excel"
    }
    fallback => "unknown"
  }
}

output {
  elasticsearch {
    hosts => ["http://es01:9200"]
    index => "trading_symbols"
    # document_id => "%{token}" # Use token as ID to prevent duplicates if desired
  }
  stdout { codec => rubydebug }
}
